<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>M√©mo scolaire CM1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
            text-align: center;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.8rem;
        }

        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        button {
            font-size: 1.1rem;
            padding: 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 60px;
            font-weight: 500;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        .grille-profils {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .profil-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .profil-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .profil-emoji {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .profil-nom {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .profil-couleur-preview {
            height: 8px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .btn-ajouter-profil {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.2rem;
            padding: 20px;
        }

        .btn-info {
            background: transparent;
            color: #9ca3af;
            font-size: 0.95rem;
            padding: 12px;
            margin-top: 15px;
            border: 1px solid #d1d5db;
            min-height: auto;
        }

        .btn-info:hover {
            background: #f3f4f6;
            color: #6b7280;
        }

        .input-prenom {
            width: 100%;
            max-width: 300px;
            padding: 16px;
            font-size: 1.2rem;
            border: 2px solid #ccc;
            border-radius: 12px;
            margin: 20px auto;
            text-align: center;
            display: block;
        }

        .selecteur-emojis,
        .selecteur-couleurs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-width: 450px;
            margin: 20px auto;
        }

        .emoji-option,
        .couleur-option {
            padding: 10px;
            border: 3px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-option:hover,
        .couleur-option:hover {
            transform: scale(1.1);
        }

        .emoji-option.selectionne,
        .couleur-option.selectionne {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .couleur-option {
            height: 60px;
        }

        .boutons-action {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .boutons-action button {
            flex: 1;
            max-width: 200px;
            min-width: 140px;
        }

        .grille-matieres {
            grid-template-columns: 1fr 1fr;
            display: grid;
            gap: 20px;
            margin: 30px 0;
        }

        .bloc-matiere {
            padding: 50px 20px;
            font-size: 1.6rem;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bloc-matiere:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .bloc-matiere.maths { background: #93c5fd; }
        .bloc-matiere.francais { background: #fca5a5; }

        .btn-progression {
            background: #a78bfa;
            color: white;
            font-size: 1.3rem;
            padding: 20px 40px;
            margin: 20px auto;
            display: block;
            width: fit-content;
            min-width: 280px;
        }

        .grille-chapitres {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .bloc-chapitre {
            padding: 35px 20px;
            border-radius: 16px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 100px;
        }

        .bloc-chapitre:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .conjugaison { background: #dbeafe; }
        .grammaire { background: #dcfce7; }
        .orthographe { background: #fef3c7; }
        .lexique { background: #fae8ff; }
        .nombres { background: #bfdbfe; }
        .calcul { background: #bbf7d0; }
        .geometrie { background: #fed7aa; }
        .mesures { background: #e9d5ff; }

        .grille-lecons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .bouton-lecon {
            height: 90px;
            font-size: 0.95rem;
            padding: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            cursor: pointer;
        }

        .badge-lecon {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .badge-orange {
            background: #fb923c;
            color: white;
        }

        .badge-vert {
            background: #22c55e;
            color: white;
        }

        .btn-lecon {
            width: 100%;
            background: #2563eb;
            color: white;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .ligne-exercices {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .exercice-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-exercice {
            background: #10b981;
            color: white;
            font-size: 1.2rem;
            position: relative;
            width: 100%;
        }

        .btn-exercice:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .btn-exercice.reussi {
            background: #059669;
            border: 3px solid #10b981;
        }

        .btn-exercice.reussi::after {
            content: "‚úì";
            position: absolute;
            top: 8px;
            right: 15px;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .btn-validation {
            background: #f59e0b;
            color: white;
            font-size: 1rem;
            padding: 12px;
            width: 100%;
        }

        button:disabled {
            opacity: 0.5;
        }

        #changer-eleve, .retour-menu, .retour-chapitres, .retour-progression, #se-deconnecter {
            background: #6b7280;
            color: white;
            margin-top: 20px;
        }

        .navigation-rapide {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .navigation-rapide button {
            flex: 1;
            font-size: 1rem;
            padding: 12px;
            min-width: 150px;
        }

        .navigation-rapide .retour-lecons {
            background: #4b5563;
            color: white;
            margin-top: 0;
        }

        .navigation-rapide .retour-chapitres-rapide,
        .navigation-rapide .retour-menu-rapide {
            background: #9ca3af;
            color: white;
        }

        .titre-avec-retour {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .titre-avec-retour h1 {
            margin: 0;
        }

        .btn-retour-haut {
            background: #6b7280;
            color: white;
            font-size: 1rem;
            padding: 12px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-retour-haut:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-retour-haut:active {
            transform: translateY(0);
        }

        small {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .progression-section {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .progression-globale {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stats-matiere {
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
        }

        .stats-matiere.francais-stats {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stats-matiere.maths-stats {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .pourcentage-global {
            font-size: 3rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .detail-chapitre {
            margin: 15px 0;
            text-align: left;
        }

        .nom-chapitre {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .barre-progression {
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            display: flex;
        }

        .barre-remplie {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .barre-remplie.complete {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .barre-remplie.partielle {
            background: linear-gradient(90deg, #fb923c 0%, #f97316 100%);
        }

        .reset-button {
            background: #ef4444;
            color: white;
            margin-top: 20px;
        }

        .etoiles {
            font-size: 2rem;
            margin: 10px 0;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.actif {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            margin-top: 0;
            color: #333;
        }

        .modal-content p {
            margin: 20px 0;
            color: #666;
            font-size: 1.1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .modal-buttons button {
            flex: 1;
            min-width: 120px;
        }

        .btn-confirmer {
            background: #ef4444;
            color: white;
        }

        .btn-annuler {
            background: #6b7280;
            color: white;
        }

        .btn-supprimer {
            background: #dc2626;
            color: white;
            margin-top: 10px;
            font-size: 0.9rem;
            padding: 10px;
        }

        .encadre-aide {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
            font-size: 0.95rem;
        }

        .encadre-aide strong {
            color: #1e40af;
            display: block;
            margin-bottom: 8px;
            font-size: 1.05rem;
        }

        .info-section {
            background: white;
            padding: 25px;
            border-radius: 16px;
            margin: 15px 0;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-section h2 {
            color: #1e40af;
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-section p, .info-section ul {
            color: #4b5563;
            line-height: 1.7;
            margin: 10px 0;
        }

        .info-section ul {
            padding-left: 20px;
        }

        .info-section li {
            margin: 8px 0;
        }

        .credits {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            font-style: italic;
            color: #6b7280;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.2rem; }
            
            .grille-profils {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grille-matieres {
                grid-template-columns: 1fr;
            }
            
            .grille-lecons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ligne-exercices {
                flex-direction: column;
            }
            
            .navigation-rapide {
                flex-direction: column;
            }
            
            .navigation-rapide button {
                width: 100%;
            }

            .selecteur-emojis,
            .selecteur-couleurs {
                max-width: 100%;
                padding: 0 10px;
            }

            .emoji-option {
                font-size: 1.8rem;
                padding: 8px;
            }

            .couleur-option {
                height: 50px;
            }
        }
    </style>
<!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M√©mo CM1">
    <link rel="apple-touch-icon" href="icon-192.png">
</head>
<body>

<div class="container" id="accueil">
    <h1>üéì M√©mo Scolaire CM1</h1>
    <p>Choisis ton profil :</p>
    <div class="grille-profils" id="grille-profils"></div>
    <button class="btn-ajouter-profil" id="btn-ajouter-profil">+ Ajouter un enfant</button>
    <button class="btn-info" id="btn-info">‚ÑπÔ∏è Comment √ßa marche ?</button>
</div>

<div class="container" id="creation-profil" style="display:none;">
    <h1>Cr√©er mon profil</h1>
    <input type="text" class="input-prenom" id="input-prenom" placeholder="Entre ton pr√©nom" maxlength="20">
    <h2>Choisis ton emoji :</h2>
    <div class="selecteur-emojis" id="selecteur-emojis"></div>
    <h2>Choisis ta couleur :</h2>
    <div class="selecteur-couleurs" id="selecteur-couleurs"></div>
    <div class="boutons-action">
        <button class="btn-annuler" id="btn-annuler-creation">Annuler</button>
        <button class="btn-confirmer" id="btn-confirmer-creation">Cr√©er</button>
    </div>
</div>

<div class="container" id="page-info" style="display:none;">
    <h1>‚ÑπÔ∏è Comment √ßa marche ?</h1>

    <div class="info-section">
        <h2>üéØ √Ä quoi sert cette appli ?</h2>
        <p>Cette application centralise tous les QR codes de tes manuels de CM1 (Fran√ßais et Maths) en un seul endroit !</p>
        <p>Plus besoin de scanner les QR codes : tout est accessible en quelques clics.</p>
    </div>

    <div class="info-section">
        <h2>üìö Contenu disponible</h2>
        <ul>
            <li><strong>Fran√ßais</strong> : 33 le√ßons r√©parties en 4 chapitres
                <ul>
                    <li>Conjugaison (13 le√ßons)</li>
                    <li>Grammaire (9 le√ßons)</li>
                    <li>Orthographe (6 le√ßons)</li>
                    <li>Lexique (5 le√ßons)</li>
                </ul>
            </li>
            <li><strong>Maths</strong> : 51 le√ßons r√©parties en 4 chapitres
                <ul>
                    <li>Nombres (14 le√ßons)</li>
                    <li>Calcul (12 le√ßons)</li>
                    <li>Espaces & G√©om√©trie (15 le√ßons)</li>
                    <li>Grandeurs et mesures (10 le√ßons)</li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="info-section">
        <h2>‚úèÔ∏è Pour chaque le√ßon</h2>
        <ul>
            <li>üìò Un lien vers la le√ßon compl√®te</li>
            <li>‚úèÔ∏è Un ou deux exercices interactifs</li>
            <li>‚úì Un syst√®me de validation "J'ai r√©ussi"</li>
        </ul>
    </div>

    <div class="info-section">
        <h2>üèÜ Suivi de progression</h2>
        <p>Chaque enfant peut suivre sa progression :</p>
        <ul>
            <li>üü† <strong>Badge orange</strong> = 1 exercice termin√©</li>
            <li>üü¢ <strong>Badge vert</strong> = Le√ßon compl√®te (tous les exercices faits)</li>
            <li>üìä Consulte ta progression dans "Ma progression"</li>
            <li>‚≠ê Gagne des √©toiles en progressant !</li>
        </ul>
    </div>

    <div class="info-section">
        <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Plusieurs enfants</h2>
        <p>Chaque enfant peut cr√©er son propre profil avec :</p>
        <ul>
            <li>üé® Son pr√©nom personnalis√©</li>
            <li>üòä Son emoji pr√©f√©r√©</li>
            <li>üåà Sa couleur favorite</li>
            <li>üìà Sa propre progression sauvegard√©e</li>
        </ul>
    </div>

    <div class="credits">
        üë®‚Äçüíª Cr√©√© par <strong>Damien</strong> - Papa de Valentin<br>
        Avec ‚ù§Ô∏è pour faciliter l'apprentissage des CM1
    </div>

    <button style="background: #6b7280; color: white; margin-top: 30px; padding: 16px; border: none; border-radius: 12px; cursor: pointer; min-height: 60px; font-weight: 500;" id="btn-retour-info-accueil">Retour √† l'accueil</button>
</div>

<div class="container" id="menu" style="display:none;">
    <h1>Choisis ton m√©mo</h1>
    <div class="grille-matieres">
        <div class="bloc-matiere maths">üìê M√©mo Maths</div>
        <div class="bloc-matiere francais">üìö M√©mo Fran√ßais</div>
    </div>
    <button class="btn-progression" id="btn-progression">üìä Ma progression</button>
    <button id="se-deconnecter">Se d√©connecter</button>
</div>

<div class="container" id="chapitres" style="display:none;">
    <h1 id="titre-chapitres"></h1>
    <div class="grille-chapitres" id="grille-chapitres"></div>
    <button class="retour-menu">Retour au menu</button>
</div>

<div class="container" id="lecons" style="display:none;">
    <h1 id="titre-lecons"></h1>
    <div id="liste-lecons" class="grille-lecons"></div>
    <button class="retour-chapitres">Retour aux chapitres</button>
</div>

<div class="container" id="lecon-detail" style="display:none;">
    <h1 id="titre-lecon-detail"></h1>

    <div class="encadre-aide">
        <strong>üí° N'oublie pas :</strong>
        Apr√®s avoir fait l'exercice, ferme la fen√™tre qui s'est ouverte, puis reviens ici et clique sur "‚úì J'ai r√©ussi" !
    </div>

    <button class="btn-lecon" id="btn-lecon">üìò Ouvrir la le√ßon</button>

    <div class="ligne-exercices">
        <div class="exercice-container">
            <button class="btn-exercice" id="btn-ex1">‚úèÔ∏è Exercice 1</button>
            <button class="btn-validation" id="btn-valider-ex1">‚úì J'ai r√©ussi</button>
        </div>
        <div class="exercice-container">
            <button class="btn-exercice" id="btn-ex2">‚úèÔ∏è Exercice 2</button>
            <button class="btn-validation" id="btn-valider-ex2">‚úì J'ai r√©ussi</button>
        </div>
    </div>

    <div class="navigation-rapide">
        <button class="retour-menu-rapide">‚Üê Retour au menu</button>
        <button class="retour-chapitres-rapide">‚Üê Retour aux chapitres</button>
        <button class="retour-lecons">‚Üê Retour aux le√ßons</button>
    </div>
</div>

<div class="container" id="progression" style="display:none;">
    <div class="titre-avec-retour">
        <button class="btn-retour-haut retour-progression-haut">‚Üê Retour</button>
        <h1>üìä Ma progression</h1>
    </div>
    <div class="progression-globale">
        <div class="stats-matiere francais-stats">
            <h2>üìö Fran√ßais</h2>
            <div class="pourcentage-global" id="pct-francais">0%</div>
            <div id="etoiles-francais" class="etoiles"></div>
            <p id="detail-francais"></p>
        </div>
        <div class="stats-matiere maths-stats">
            <h2>üìê Maths</h2>
            <div class="pourcentage-global" id="pct-maths">0%</div>
            <div id="etoiles-maths" class="etoiles"></div>
            <p id="detail-maths"></p>
        </div>
    </div>
    <div class="progression-section">
        <h2>üìö D√©tail Fran√ßais</h2>
        <div id="detail-chapitres-francais"></div>
    </div>
    <div class="progression-section">
        <h2>üìê D√©tail Maths</h2>
        <div id="detail-chapitres-maths"></div>
    </div>
    <button class="reset-button" id="reset-progression">üîÑ R√©initialiser ma progression</button>
    <button class="retour-progression">Retour au menu</button>
</div>

<div class="modal-overlay" id="modal-confirmation">
    <div class="modal-content">
        <h2>‚ö†Ô∏è Attention</h2>
        <p>Es-tu s√ªr(e) de vouloir effacer toute ta progression ?<br><br>Cette action est <strong>irr√©versible</strong>.</p>
        <div class="modal-buttons">
            <button class="btn-annuler" id="btn-annuler-reset">Annuler</button>
            <button class="btn-confirmer" id="btn-confirmer-reset">Oui, tout effacer</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-supprimer-profil">
    <div class="modal-content">
        <h2>G√©rer le profil</h2>
        <p id="nom-profil-modal"></p>
        <div class="modal-buttons">
            <button class="btn-annuler" id="btn-annuler-suppression">Annuler</button>
            <button class="btn-supprimer" id="btn-confirmer-suppression">üóëÔ∏è Supprimer ce profil</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-tutoriel">
    <div class="modal-content">
        <h2>üí° Comment √ßa marche ?</h2>
        <p style="text-align: left; line-height: 1.8; font-size: 1.05rem;">
            <strong>1Ô∏è‚É£</strong> Clique sur "üìò Ouvrir la le√ßon" ou "‚úèÔ∏è Exercice"<br>
            <strong>2Ô∏è‚É£</strong> Une nouvelle fen√™tre s'ouvre<br>
            <strong>3Ô∏è‚É£</strong> Fais l'exercice sur le site<br>
            <strong>4Ô∏è‚É£</strong> <span style="background: #fef3c7; padding: 2px 6px; border-radius: 4px;">Ferme la fen√™tre</span> quand tu as termin√©<br>
            <strong>5Ô∏è‚É£</strong> Reviens ici et clique sur <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px;">‚úì J'ai r√©ussi</span>
        </p>
        <button class="btn-confirmer" id="btn-compris-tutoriel" style="width: 100%; margin-top: 15px;">J'ai compris !</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const emojis = ['üë¶', 'üëß', 'üê∂', 'üê±', 'ü¶Å', 'üêº', 'üöÄ', '‚öΩ', 'üé®', 'üéÆ'];
    const couleurs = [
        { nom: 'Bleu', code: '#3b82f6' },
        { nom: 'Vert', code: '#10b981' },
        { nom: 'Jaune', code: '#eab308' },
        { nom: 'Orange', code: '#f97316' },
        { nom: 'Rouge', code: '#ef4444' },
        { nom: 'Violet', code: '#a855f7' },
        { nom: 'Rose', code: '#ec4899' },
        { nom: 'Gris', code: '#6b7280' },
        { nom: 'Noir', code: '#1f2937' }
    ];

    let emojiSelectionne = emojis[0];
    let couleurSelectionnee = couleurs[0].code;
    let profilEnCoursSuppr = null;

    const donnees = {
        Fran√ßais: {
            Conjugaison: {
                titre: "Conjugaison",
                couleur: "#dbeafe",
                classe: "conjugaison",
                lecons: [
                    {titre: "C1 - Le verbe : infinitif, groupe, temps, mode", lecon: "https://dgxy.link/verbe", ex1: "https://learningapps.org/display?v=pipm9xss521", ex2: "https://learningapps.org/display?v=p29a2vp5c21"},
                    {titre: "C2 - Le pr√©sent de l'indicatif : verbes du groupe 1 et 2", lecon: "https://dgxy.link/pres1", ex1: "https://learningapps.org/display?v=pvpti5thn21", ex2: "https://learningapps.org/display?v=pjaey8isj21"},
                    {titre: "C3 - Le pr√©sent de l'indicatif : verbes du 3eme groupe", lecon: "https://dgxy.link/pres2", ex1: "https://learningapps.org/watch?v=puvaj48wa21", ex2: "https://learningapps.org/watch?v=phracs4sa21"},
                    {titre: "C4 - Le futur simple", lecon: "https://dgxy.link/fut", ex1: "https://learningapps.org/watch?v=pik6pktgt21", ex2: "https://learningapps.org/watch?v=pxun6asjn21"},
                    {titre: "C5 - L'imparfait : verbes du groupe 1 et 2", lecon: "https://dgxy.link/imp1", ex1: "https://learningapps.org/watch?v=pnoqhssan21", ex2: "https://learningapps.org/watch?v=pn79doc8521"},
                    {titre: "C6 - L'imparfait : verbes du 3eme groupe", lecon: "https://dgxy.link/imp2", ex1: "https://learningapps.org/watch?v=pt2ku7i3n21", ex2: "https://learningapps.org/watch?v=pnnu816kk21"},
                    {titre: "C7 - Le pass√© simple : verbes du groupe 1, 2 et 3", lecon: "https://dgxy.link/ps1", ex1: "https://learningapps.org/watch?v=pqf3wf1m221", ex2: "https://learningapps.org/watch?v=pyebhg5hk21"},
                    {titre: "C8 - Le pass√© simple : autres verbes du 3eme groupe", lecon: "https://dgxy.link/ps2", ex1: "https://learningapps.org/watch?v=p7vcjy8h321", ex2: "https://learningapps.org/watch?v=prqy5h6d521"},
                    {titre: "C9 - Le pass√© compos√© avec l'auxiliaire avoir", lecon: "https://dgxy.link/pc", ex1: "https://learningapps.org/watch?v=pkz6goyqj21", ex2: "https://learningapps.org/watch?v=p60cqy11t21"},
                    {titre: "C10 - Le pass√© compos√© avec l'auxiliaire √™tre", lecon: "https://dgxy.link/pc", ex1: "https://learningapps.org/watch?v=poosjjo2c21", ex2: "https://learningapps.org/watch?v=pzibpycdk21"},
                    {titre: "C11 - Le plus-que-parfait", lecon: "https://dgxy.link/pqp", ex1: "https://learningapps.org/watch?v=pkkq2oza521", ex2: "https://learningapps.org/watch?v=pfev1wr6k21"},
                    {titre: "C12 - Le pr√©sent de l'imp√©ratif", lecon: "https://dgxy.link/imper", ex1: "https://learningapps.org/watch?v=pa00r8pua21", ex2: "https://learningapps.org/watch?v=peopepbwa21"},
                    {titre: "C13 - Le pr√©sent du conditionnel", lecon: "https://dgxy.link/cond", ex1: "https://learningapps.org/watch?v=p1no1ieij21", ex2: "https://learningapps.org/watch?v=ppyxasgpn21"}
                ]
            },
            Grammaire: {
                titre: "Grammaire",
                couleur: "#dcfce7",
                classe: "grammaire",
                lecons: [
                    {titre: "G1 - La phrase, les types et formes de phrase", lecon: "https://dgxy.link/phrase", ex1: "https://learningapps.org/watch?v=pgbtadbuk21", ex2: "https://learningapps.org/watch?v=pk5to4p5k21"},
                    {titre: "G2 - Les phrases simples et complexes", lecon: "https://dgxy.link/comp", ex1: "https://learningapps.org/watch?v=puj7opqt321", ex2: "https://learningapps.org/watch?v=pa7du9"},
                    {titre: "G3 - Le groupe nominal et ses composants", lecon: "https://dgxy.link/GN", ex1: "https://learningapps.org/watch?v=punakzsqk21", ex2: "https://learningapps.org/watch?v=pedzziqkj21"},
                    {titre: "G4 - Les d√©terminants", lecon: "https://dgxy.link/det", ex1: "https://learningapps.org/watch?v=p7g9j997221", ex2: "https://learningapps.org/watch?v=pt6p03p7n21"},
                    {titre: "G5 - Les pronoms", lecon: "https://dgxy.link/pron", ex1: "https://learningapps.org/watch?v=pyo832djc21", ex2: "https://learningapps.org/watch?v=p9rxt65fj21"},
                    {titre: "G6 - Le verbe et le sujet", lecon: "https://dgxy.link/vsuj", ex1: "https://learningapps.org/watch?v=psr47ixg521", ex2: "https://learningapps.org/watch?v=pva80aght21"},
                    {titre: "G7 - Les compl√©ments d'objets (COD et COI)", lecon: "https://dgxy.link/codcoi", ex1: "https://learningapps.org/watch?v=pxj0kfv5521", ex2: "https://learningapps.org/watch?v=pjufc1di321"},
                    {titre: "G8 - L'attribut du sujet", lecon: "https://dgxy.link/asuj", ex1: "https://learningapps.org/watch?v=po28wp5fj21", ex2: "https://learningapps.org/watch?v=pjz1nk7p521"},
                    {titre: "G9 - Les compl√©ments circonstanciels", lecon: "https://dgxy.link/ccir", ex1: "https://learningapps.org/watch?v=pjuifk9s521", ex2: "https://learningapps.org/watch?v=pkexxkoik21"}
                ]
            },
            Orthographe: {
                titre: "Orthographe",
                couleur: "#fef3c7",
                classe: "orthographe",
                lecons: [
                    {titre: "O1 - R√®gles d'orthographe √† connaitre", lecon: "https://dgxy.link/ort", ex1: "https://learningapps.org/watch?v=pytij19n521", ex2: "https://learningapps.org/watch?v=phh7rypbj21"},
                    {titre: "O2 - Les homophones grammaticaux (1/2)", lecon: "https://dgxy.link/hom1", ex1: "https://learningapps.org/watch?v=p6s3kvcg221", ex2: "https://learningapps.org/watch?v=phg0rmth321"},
                    {titre: "O3 - Les homophones grammaticaux (2/2)", lecon: "https://dgxy.link/hom2", ex1: "https://learningapps.org/watch?v=p89e2hn5521", ex2: "https://learningapps.org/watch?v=p6mc7i2bc21"},
                    {titre: "O4 - La formation du f√©minin des noms et des adjectifs", lecon: "https://dgxy.link/fem", ex1: "https://learningapps.org/watch?v=pbt3bb4ok21", ex2: "https://learningapps.org/watch?v=pibbkiy4a21"},
                    {titre: "O5 - La formation du pluriel des noms et des adjectifs", lecon: "https://dgxy.link/plur", ex1: "https://learningapps.org/watch?v=pbksudpmj21", ex2: "https://learningapps.org/watch?v=puitynank21"},
                    {titre: "O6 - Le participe pass√© et l'infinitif", lecon: "https://dgxy.link/part", ex1: "https://learningapps.org/watch?v=psdyyw5e321", ex2: "https://learningapps.org/watch?v=pkq0ytdcn21"}
                ]
            },
            Lexique: {
                titre: "Lexique",
                couleur: "#fae8ff",
                classe: "lexique",
                lecons: [
                    {titre: "L1 - Le dictionnaire - la polys√©mie", lecon: "https://dgxy.link/dic", ex1: "https://learningapps.org/watch?v=p6svrrxw321", ex2: "https://learningapps.org/watch?v=pc8n36wt521"},
                    {titre: "L2 - Les familles de mots - la d√©rivation", lecon: "https://dgxy.link/fam", ex1: "https://learningapps.org/watch?v=pcfo7fhma21", ex2: "https://learningapps.org/watch?v=pdduvxw9t21"},
                    {titre: "L3 - Les noms g√©n√©riques et particuliers", lecon: "https://dgxy.link/gen", ex1: "https://learningapps.org/watch?v=pwgffexeua21", ex2: "https://learningapps.org/watch?v=pp2zwzr8k21"},
                    {titre: "L4 - L'homonymie, synonymie et antonymie", lecon: "https://dgxy.link/syn", ex1: "https://learningapps.org/watch?v=pwayujzvc21", ex2: "https://learningapps.org/watch?v=p0rfmn53321"},
                    {titre: "L5 - Les niveaux de langage", lecon: "https://dgxy.link/lang", ex1: "https://learningapps.org/watch?v=pno7xx2m321", ex2: "https://learningapps.org/watch?v=paa9ggq2n21"}
                ]
            }
        },
        Maths: {
            Nombres: {
                titre: "Nombres",
                couleur: "#bfdbfe",
                classe: "nombres",
                lecons: [
                    {titre: "Num1 - Lire, √©crire et d√©composer les nombres jusqu'√† 999 999", lecon: "https://dgxy.link/lirenb", ex1: "https://learningapps.org/watch?v=py43yb7v521", ex2: null},
                    {titre: "Num2 - Placer, encadrer, comparer, ranger les nombres jusqu'√† 999 999", lecon: "https://dgxy.link/compnb", ex1: "https://learningapps.org/watch?v=p8y82dwwk21", ex2: null},
                    {titre: "Num3 - Lire, √©crire et d√©composer les nombres jusqu'√† 999 999 999", lecon: "https://dgxy.link/lirenb", ex1: "https://learningapps.org/watch?v=pysrrte9t21", ex2: null},
                    {titre: "Num4 - Placer, encadrer, comparer, ranger les nombres jusqu'√† 999 999 999", lecon: "https://dgxy.link/compnb", ex1: "https://learningapps.org/watch?v=ptdhm6vec21", ex2: null},
                    {titre: "Num5 - Lire, √©crire et d√©composer les grands nombres", lecon: "https://dgxy.link/lirenb", ex1: "https://learningapps.org/watch?v=p1fcd0pec21", ex2: null},
                    {titre: "Num6 - Placer, encadrer, comparer, ranger les grands nombres", lecon: "https://dgxy.link/compnb", ex1: "https://learningapps.org/watch?v=p8ve0i3ia21", ex2: null},
                    {titre: "Num7 - Lire, √©crire et repr√©senter les fractions", lecon: "https://dgxy.link/fraclir", ex1: "https://learningapps.org/watch?v=phubkjgqk21", ex2: null},
                    {titre: "Num8 - Comparer les fractions", lecon: "https://dgxy.link/compfrac", ex1: "https://learningapps.org/watch?v=ppdhb9wmj21", ex2: null},
                    {titre: "Num9 - Connaitre les √©quivalences entre fractions", lecon: "https://dgxy.link/equfrac", ex1: "https://learningapps.org/watch?v=ptb7drg0321", ex2: null},
                    {titre: "Num10 - D√©composer et encadrer les fractions", lecon: "https://dgxy.link/decfrac", ex1: "https://learningapps.org/watch?v=p0kp7vxd521", ex2: null},
                    {titre: "Num11 - Connaitre les fractions d√©cimales", lecon: "https://dgxy.link/fracde", ex1: "https://learningapps.org/watch?v=pvcyfkj7221", ex2: null},
                    {titre: "Num12 - Passer de l'√©criture fractionnaire aux nombres d√©cimaux", lecon: "https://dgxy.link/fracde2", ex1: "https://learningapps.org/watch?v=p0fmrm6wa21", ex2: null},
                    {titre: "Num13 - Lire, √©crire, arrondir et d√©composer les nombres d√©cimaux", lecon: "https://dgxy.link/liredec", ex1: "https://learningapps.org/watch?v=p44pnbvr521", ex2: null},
                    {titre: "Num14 - Comparer, encadrer et ranger les nombres d√©cimaux", lecon: "https://dgxy.link/compdec", ex1: "https://learningapps.org/watch?v=prcvdaoe221", ex2: null}
                ]
            },
            Calcul: {
                titre: "Calcul",
                couleur: "#bbf7d0",
                classe: "calcul",
                lecons: [
                    {titre: "Calc1 - Additionner et soustraire des nombres entiers", lecon: "https://dgxy.link/add1", ex1: "https://learningapps.org/watch?v=priu3128a21", ex2: null},
                    {titre: "Calc2 - Additionner des nombres d√©cimaux", lecon: "https://dgxy.link/addec", ex1: "https://learningapps.org/watch?v=pkwydq9sk21", ex2: null},
                    {titre: "Calc3 - Soustraire des nombres d√©cimaux", lecon: "https://dgxy.link/soudec", ex1: "https://learningapps.org/watch?v=pyxpdbzq321", ex2: null},
                    {titre: "Calc4 - Multiplier par un nombre √† un chiffre", lecon: "https://dgxy.link/mult", ex1: "https://learningapps.org/watch?v=pcb74m1et21", ex2: null},
                    {titre: "Calc5 - Multiplier par un nombre √† plusieurs chiffres", lecon: "https://dgxy.link/mult2", ex1: "https://learningapps.org/watch?v=pzvxss3da19", ex2: null},
                    {titre: "Calc6 - Multiplier des nombres d√©cimaux", lecon: "https://dgxy.link/mult3", ex1: "https://learningapps.org/watch?v=p07o4ydun21", ex2: null},
                    {titre: "Calc7 - Connaitre les multiples et diviseurs d'un nombre", lecon: "https://dgxy.link/muldiv", ex1: "https://learningapps.org/watch?v=ps6qppjs221", ex2: null},
                    {titre: "Calc8 - Diviser un nombre entier par un nombre √† un chiffre", lecon: "https://dgxy.link/divi", ex1: "https://learningapps.org/watch?v=pekdhytm521", ex2: null},
                    {titre: "Calc9 - Diviser un nombre entier par un nombre √† plusieurs chiffres", lecon: "https://dgxy.link/divi2", ex1: "https://learningapps.org/view5419244", ex2: null},
                    {titre: "Calc10 - Effectuer une division avec un quotient d√©cimal", lecon: "https://dgxy.link/divi3", ex1: "https://learningapps.org/watch?v=pqagese7321", ex2: null},
                    {titre: "Calc11 - Diviser un nombre d√©cimal par un nombre entier", lecon: "https://dgxy.link/divdec", ex1: "https://learningapps.org/watch?v=p3nvbb4wj21", ex2: null},
                    {titre: "Calc12 - Additionner et soustraire des fractions", lecon: "https://dgxy.link/adfrac", ex1: "https://learningapps.org/watch?v=pnoqojhgc21", ex2: null}
                ]
            },
            G√©om√©trie: {
                titre: "Espaces & G√©om√©trie",
                couleur: "#fed7aa",
                classe: "geometrie",
                lecons: [
                    {titre: "G√©om1 - Connaitre le vocabulaire et le codage g√©om√©trique", lecon: "https://dgxy.link/vocgeo", ex1: "https://learningapps.org/view5419836", ex2: null},
                    {titre: "G√©om2 - Reconnaitre et tracer des droites perpendiculaires", lecon: "https://dgxy.link/perp", ex1: "https://learningapps.org/watch?v=pfsv7kpe519", ex2: null},
                    {titre: "G√©om3 - Reconnaitre et tracer des droites parall√®les", lecon: "https://dgxy.link/para", ex1: "https://learningapps.org/watch?v=pp0n3mtx319", ex2: null},
                    {titre: "G√©om4 - Connaitre les polygones", lecon: "https://dgxy.link/polyg", ex1: "https://learningapps.org/watch?v=p4hn1fick19", ex2: null},
                    {titre: "G√©om5 - Connaitre les quadrilat√®res", lecon: "https://dgxy.link/quad", ex1: "https://learningapps.org/watch?v=pemkifte319", ex2: null},
                    {titre: "G√©om6 - Tracer les quadrilat√®res", lecon: "https://dgxy.link/quad1", ex1: "https://learningapps.org/watch?v=pomaw4oc519", ex2: null},
                    {titre: "G√©om7 - Connaitre les triangles", lecon: "https://dgxy.link/tria", ex1: "https://learningapps.org/watch?v=pi9pw9cmk19", ex2: null},
                    {titre: "G√©om8 - Tracer les triangles", lecon: "https://dgxy.link/tria1", ex1: "https://learningapps.org/watch?v=prs0kxxok19", ex2: null},
                    {titre: "G√©om9 - Connaitre et tracer des cercles", lecon: "https://dgxy.link/cerc", ex1: "https://learningapps.org/view5420192", ex2: null},
                    {titre: "G√©om10 - Suivre et r√©diger un programme de construction", lecon: "https://dgxy.link/proco", ex1: "https://learningapps.org/watch?v=ph26hudn519", ex2: null},
                    {titre: "G√©om11 - Connaitre les solides", lecon: "https://dgxy.link/soli", ex1: "https://learningapps.org/watch?v=pittkhdrc19", ex2: null},
                    {titre: "G√©om12 - Reconnaitre la sym√©trie axiale", lecon: "https://dgxy.link/sym", ex1: "https://learningapps.org/watch?v=pftc20jca19", ex2: null},
                    {titre: "G√©om13 - Tracer une figure par sym√©trie axiale", lecon: "https://dgxy.link/sym2", ex1: "https://learningapps.org/watch?v=p0o5e97oa19", ex2: null},
                    {titre: "G√©om14 - Se rep√©rer et se d√©placer dans un quadrillage", lecon: "https://dgxy.link/quadr", ex1: "https://learningapps.org/watch?v=pb9zvfzi219", ex2: null},
                    {titre: "G√©om15 - Utiliser un logiciel de programmation", lecon: "https://dgxy.link/lopro", ex1: "https://learningapps.org/watch?v=pqima7ym519", ex2: null}
                ]
            },
            Mesures: {
                titre: "Grandeurs et mesures",
                couleur: "#e9d5ff",
                classe: "mesures",
                lecons: [
                    {titre: "Mes1 - Connaitre les mesures de dur√©e", lecon: "https://dgxy.link/dur", ex1: "https://learningapps.org/watch?v=pz7d6zw0n19", ex2: null},
                    {titre: "Mes2 - Calculer des dur√©es", lecon: "https://dgxy.link/dur1", ex1: "https://learningapps.org/watch?v=penkwr19k19", ex2: null},
                    {titre: "Mes3 - Connaitre les unit√©s de mesure de longueur", lecon: "https://dgxy.link/long", ex1: "https://learningapps.org/watch?v=pk76j0mdc19", ex2: null},
                    {titre: "Mes4 - Calculer le p√©rim√®tre d'un polygone", lecon: "https://dgxy.link/peri", ex1: "https://learningapps.org/watch?v=ptmohnc3t19", ex2: null},
                    {titre: "Mes5 - Connaitre les unit√©s de mesure de masse", lecon: "https://dgxy.link/masse", ex1: "https://learningapps.org/watch?v=pokvmjok519", ex2: null},
                    {titre: "Mes6 - Connaitre les unit√©s de mesure de contenance", lecon: "https://dgxy.link/cont1", ex1: "https://learningapps.org/watch?v=p8kf8fn0a19", ex2: null},
                    {titre: "Mes7 - Identifier et comparer des angles", lecon: "https://dgxy.link/angl", ex1: "https://learningapps.org/watch?v=pa6kbzfck19", ex2: null},
                    {titre: "Mes8 - Tracer et reproduire des angles", lecon: "https://dgxy.link/angl1", ex1: "https://learningapps.org/watch?v=psv17hswc19", ex2: null},
                    {titre: "Mes9 - Connaitre les unit√©s de mesure d'aires", lecon: "https://dgxy.link/aire", ex1: "https://learningapps.org/watch?v=pokqzkjjk19", ex2: null},
                    {titre: "Mes10 - Calculer des aires", lecon: "https://dgxy.link/aire1", ex1: "https://learningapps.org/watch?v=pz2v2p93n19", ex2: null}
                ]
            }
        }
    };

    let profilActuel = null;

    function getProfils() {
        const data = localStorage.getItem('profils');
        return data ? JSON.parse(data) : {};
    }

    function saveProfils(profils) {
        localStorage.setItem('profils', JSON.stringify(profils));
    }

    function getProgression() {
        if (!profilActuel) return {};
        const profils = getProfils();
        return profils[profilActuel]?.progression || {};
    }

    function saveProgression(progression) {
        if (!profilActuel) return;
        const profils = getProfils();
        if (!profils[profilActuel]) profils[profilActuel] = {};
        profils[profilActuel].progression = progression;
        saveProfils(profils);
    }

    function aTutorielVu() {
        if (!profilActuel) return true;
        const profils = getProfils();
        return profils[profilActuel]?.tutorielVu || false;
    }

    function marquerTutorielVu() {
        if (!profilActuel) return;
        const profils = getProfils();
        if (!profils[profilActuel]) profils[profilActuel] = {};
        profils[profilActuel].tutorielVu = true;
        saveProfils(profils);
    }

    function afficherProfils() {
        const grille = document.getElementById('grille-profils');
        grille.innerHTML = '';
        const profils = getProfils();

        Object.keys(profils).forEach(prenom => {
            const profil = profils[prenom];
            const card = document.createElement('div');
            card.className = 'profil-card';
            card.innerHTML = `
                <div class="profil-emoji">${profil.emoji}</div>
                <div class="profil-nom">${prenom}</div>
                <div class="profil-couleur-preview" style="background: ${profil.couleur};"></div>
            `;
            
            card.onclick = () => {
                profilActuel = prenom;
                afficher('menu');
            };

            card.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                profilEnCoursSuppr = prenom;
                document.getElementById('nom-profil-modal').textContent = `Profil de ${prenom}`;
                document.getElementById('modal-supprimer-profil').classList.add('actif');
            });

            let touchTimer;
            card.addEventListener('touchstart', (e) => {
                touchTimer = setTimeout(() => {
                    e.preventDefault();
                    profilEnCoursSuppr = prenom;
                    document.getElementById('nom-profil-modal').textContent = `Profil de ${prenom}`;
                    document.getElementById('modal-supprimer-profil').classList.add('actif');
                }, 500);
            });

            card.addEventListener('touchend', () => {
                clearTimeout(touchTimer);
            });

            card.addEventListener('touchmove', () => {
                clearTimeout(touchTimer);
            });

            grille.appendChild(card);
        });
    }

    function initSelecteurs() {
        const selecteurEmojis = document.getElementById('selecteur-emojis');
        const selecteurCouleurs = document.getElementById('selecteur-couleurs');

        selecteurEmojis.innerHTML = '';
        emojis.forEach(emoji => {
            const div = document.createElement('div');
            div.className = 'emoji-option';
            div.textContent = emoji;
            if (emoji === emojiSelectionne) div.classList.add('selectionne');
            div.onclick = () => {
                document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selectionne'));
                div.classList.add('selectionne');
                emojiSelectionne = emoji;
            };
            selecteurEmojis.appendChild(div);
        });

        selecteurCouleurs.innerHTML = '';
        couleurs.forEach(c => {
const div = document.createElement('div');
div.className = 'couleur-option';
div.style.background = c.code;
if (c.code === couleurSelectionnee) div.classList.add('selectionne');
div.onclick = () => {
document.querySelectorAll('.couleur-option').forEach(e => e.classList.remove('selectionne'));
div.classList.add('selectionne');
couleurSelectionnee = c.code;
};
selecteurCouleurs.appendChild(div);
});
}
function marquerExercice(matiere, chapitre, indexLecon, numeroExercice) {
    const prog = getProgression();
    if (!prog[matiere]) prog[matiere] = {};
    if (!prog[matiere][chapitre]) prog[matiere][chapitre] = {};
    if (!prog[matiere][chapitre][indexLecon]) prog[matiere][chapitre][indexLecon] = {};
    
    prog[matiere][chapitre][indexLecon][`ex${numeroExercice}`] = true;
    saveProgression(prog);
    return prog;
}

function getStatutLecon(matiere, chapitre, indexLecon) {
    const prog = getProgression();
    const lecon = prog[matiere]?.[chapitre]?.[indexLecon];
    if (!lecon) return null;
    
    const ex1 = lecon.ex1 || false;
    const ex2 = lecon.ex2 || false;
    
    const data = donnees[matiere][chapitre].lecons[indexLecon];
    const hasEx2 = data.ex2 !== null;
    
    if (hasEx2) {
        if (ex1 && ex2) return "vert";
        if (ex1 || ex2) return "orange";
    } else {
        if (ex1) return "vert";
    }
    return null;
}

function calculerStats(matiere) {
    const prog = getProgression();
    let total = 0;
    let completes = 0;
    
    Object.keys(donnees[matiere]).forEach(chapitre => {
        donnees[matiere][chapitre].lecons.forEach((lecon, i) => {
            total++;
            if (getStatutLecon(matiere, chapitre, i) === "vert") {
                completes++;
            }
        });
    });
    
    return { total, completes, pourcentage: total > 0 ? Math.round((completes / total) * 100) : 0 };
}

const ecrans = {
    accueil: document.getElementById("accueil"),
    creationProfil: document.getElementById("creation-profil"),
    pageInfo: document.getElementById("page-info"),
    menu: document.getElementById("menu"),
    chapitres: document.getElementById("chapitres"),
    lecons: document.getElementById("lecons"),
    leconDetail: document.getElementById("lecon-detail"),
    progression: document.getElementById("progression")
};

function afficher(ecran) {
    Object.values(ecrans).forEach(e => e.style.display = "none");
    ecrans[ecran].style.display = "block";
}

let matiereActuelle = null;
let chapitreActuel = null;
let leconActuelle = null;
let indexLeconActuelle = null;

document.getElementById('btn-ajouter-profil').onclick = () => {
    emojiSelectionne = emojis[0];
    couleurSelectionnee = couleurs[0].code;
    document.getElementById('input-prenom').value = '';
    initSelecteurs();
    afficher('creationProfil');
};

document.getElementById('btn-info').onclick = () => {
    afficher('pageInfo');
};

document.getElementById('btn-retour-info-accueil').onclick = () => {
    profilActuel = null;
    afficherProfils();
    afficher('accueil');
};

document.getElementById('btn-annuler-creation').onclick = () => {
    afficher('accueil');
};

document.getElementById('btn-confirmer-creation').onclick = () => {
    const prenom = document.getElementById('input-prenom').value.trim();
    if (!prenom) {
        alert('Entre ton pr√©nom !');
        return;
    }

    const profils = getProfils();
    if (profils[prenom]) {
        alert('Ce pr√©nom existe d√©j√† !');
        return;
    }

    profils[prenom] = {
        emoji: emojiSelectionne,
        couleur: couleurSelectionnee,
        progression: {}
    };
    saveProfils(profils);
    afficherProfils();
    afficher('accueil');
};

document.querySelector(".bloc-matiere.francais").onclick = () => {
    matiereActuelle = "Fran√ßais";
    afficherChapitres();
};

document.querySelector(".bloc-matiere.maths").onclick = () => {
    matiereActuelle = "Maths";
    afficherChapitres();
};

document.getElementById("btn-progression").onclick = () => {
    afficherProgression();
};

document.getElementById("se-deconnecter").onclick = () => {
    profilActuel = null;
    afficherProfils();
    afficher("accueil");
};

function afficherChapitres() {
    if (matiereActuelle === "Fran√ßais") {
        document.getElementById("titre-chapitres").textContent = "üìö M√©mo Fran√ßais";
    } else {
        document.getElementById("titre-chapitres").textContent = "üìê M√©mo Maths";
    }
    
    const grille = document.getElementById("grille-chapitres");
    grille.innerHTML = "";

    const chapitres = donnees[matiereActuelle];
    Object.keys(chapitres).forEach(nomChapitre => {
        const data = chapitres[nomChapitre];
        const bloc = document.createElement("div");
        bloc.className = `bloc-chapitre ${data.classe}`;
        
        const premiereLecon = data.lecons[0].titre.split(' ')[0];
        const derniereLecon = data.lecons[data.lecons.length - 1].titre.split(' ')[0];
        
        bloc.innerHTML = `${data.titre}<br><small>${premiereLecon} √† ${derniereLecon}</small>`;
        bloc.onclick = () => {
            chapitreActuel = nomChapitre;
            afficherLecons();
        };
        grille.appendChild(bloc);
    });

    afficher("chapitres");
}

function afficherLecons() {
    const data = donnees[matiereActuelle][chapitreActuel];
    document.getElementById("titre-lecons").textContent = data.titre;
    const liste = document.getElementById("liste-lecons");
    liste.innerHTML = "";

    data.lecons.forEach((l, index) => {
        const btn = document.createElement("button");
        btn.className = "bouton-lecon";
        btn.style.backgroundColor = data.couleur;
        btn.textContent = l.titre;
        
        const statut = getStatutLecon(matiereActuelle, chapitreActuel, index);
        if (statut) {
            const badge = document.createElement("div");
            badge.className = `badge-lecon badge-${statut}`;
            badge.textContent = statut === "vert" ? "‚úì" : "1";
            btn.appendChild(badge);
        }
        
        btn.onclick = () => {
            leconActuelle = l;
            indexLeconActuelle = index;
            afficherDetailLecon();
        };
        liste.appendChild(btn);
    });

    afficher("lecons");
}

function afficherDetailLecon() {
    document.getElementById("titre-lecon-detail").textContent = leconActuelle.titre;
    
    const prog = getProgression();
    const leconProg = prog[matiereActuelle]?.[chapitreActuel]?.[indexLeconActuelle] || {};
    
    const btnEx1 = document.getElementById("btn-ex1");
    const btnEx2 = document.getElementById("btn-ex2");
    const btnValEx1 = document.getElementById("btn-valider-ex1");
    const btnValEx2 = document.getElementById("btn-valider-ex2");
    
    if (leconProg.ex1) {
        btnEx1.classList.add("reussi");
        btnValEx1.style.display = "none";
    } else {
        btnEx1.classList.remove("reussi");
        btnValEx1.style.display = "block";
    }
    
    if (leconActuelle.ex2) {
        btnEx2.disabled = false;
        btnEx2.parentElement.style.display = "flex";
        
        if (leconProg.ex2) {
            btnEx2.classList.add("reussi");
            btnValEx2.style.display = "none";
        } else {
            btnEx2.classList.remove("reussi");
            btnValEx2.style.display = "block";
        }
    } else {
        btnEx2.parentElement.style.display = "none";
    }

    afficher("leconDetail");
}

function afficherProgression() {
    const statsFr = calculerStats("Fran√ßais");
    const statsMa = calculerStats("Maths");
    
    document.getElementById("pct-francais").textContent = statsFr.pourcentage + "%";
    document.getElementById("detail-francais").textContent = `${statsFr.completes} / ${statsFr.total} le√ßons termin√©es`;
    document.getElementById("etoiles-francais").textContent = "‚≠ê".repeat(Math.floor(statsFr.pourcentage / 20));
    
    document.getElementById("pct-maths").textContent = statsMa.pourcentage + "%";
    document.getElementById("detail-maths").textContent = `${statsMa.completes} / ${statsMa.total} le√ßons termin√©es`;
    document.getElementById("etoiles-maths").textContent = "‚≠ê".repeat(Math.floor(statsMa.pourcentage / 20));
    
    afficherDetailChapitres("Fran√ßais", "detail-chapitres-francais");
    afficherDetailChapitres("Maths", "detail-chapitres-maths");
    
    afficher("progression");
}

function afficherDetailChapitres(matiere, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    
    Object.keys(donnees[matiere]).forEach(chapitre => {
        const data = donnees[matiere][chapitre];
        let total = data.lecons.length;
        let completes = 0;
        let partielles = 0;
        
        data.lecons.forEach((l, i) => {
            const statut = getStatutLecon(matiere, chapitre, i);
            if (statut === "vert") {
                completes++;
            } else if (statut === "orange") {
                partielles++;
            }
        });
        
        const pctComplete = total > 0 ? Math.round((completes / total) * 100) : 0;
        const pctPartielle = total > 0 ? Math.round((partielles / total) * 100) : 0;
        
        const div = document.createElement("div");
        div.className = "detail-chapitre";
        div.innerHTML = `
            <div class="nom-chapitre">
                <span>${data.titre}</span>
                <span>
                    ${completes > 0 ? '<span style="color: #10b981;">üü¢ ' + completes + '</span> ' : ''}
                    ${partielles > 0 ? '<span style="color: #fb923c;">üü† ' + partielles + '</span> ' : ''}
                    / ${total}
                </span>
            </div>
            <div class="barre-progression">
                ${pctComplete > 0 ? `<div class="barre-remplie complete" style="width: ${pctComplete}%">${pctComplete > 10 ? pctComplete + "%" : ""}</div>` : ''}
                ${pctPartielle > 0 ? `<div class="barre-remplie partielle" style="width: ${pctPartielle}%">${pctPartielle > 10 ? pctPartielle + "%" : ""}</div>` : ''}
            </div>
        `;
        container.appendChild(div);
    });
}

document.querySelectorAll(".retour-menu").forEach(btn => {
    btn.onclick = () => afficher("menu");
});
document.querySelector(".retour-chapitres").onclick = () => afficherChapitres();
document.querySelector(".retour-lecons").onclick = () => afficherLecons();
document.querySelector(".retour-progression").onclick = () => afficher("menu");
document.querySelector(".retour-progression-haut").onclick = () => afficher("menu");

document.querySelector(".retour-chapitres-rapide").onclick = () => afficherChapitres();
document.querySelector(".retour-menu-rapide").onclick = () => afficher("menu");

document.getElementById("btn-lecon").onclick = () => window.open(leconActuelle.lecon, "_blank");

document.getElementById("btn-ex1").onclick = () => {
    if (!aTutorielVu()) {
        document.getElementById("modal-tutoriel").classList.add("actif");
    } else {
        window.open(leconActuelle.ex1, "_blank");
    }
};

document.getElementById("btn-ex2").onclick = () => {
    if (leconActuelle.ex2) {
        if (!aTutorielVu()) {
            document.getElementById("modal-tutoriel").classList.add("actif");
        } else {
            window.open(leconActuelle.ex2, "_blank");
        }
    }
};

document.getElementById("btn-valider-ex1").onclick = () => {
    marquerExercice(matiereActuelle, chapitreActuel, indexLeconActuelle, 1);
    afficherDetailLecon();
};

document.getElementById("btn-valider-ex2").onclick = () => {
    marquerExercice(matiereActuelle, chapitreActuel, indexLeconActuelle, 2);
    afficherDetailLecon();
};

const modalConfirmation = document.getElementById("modal-confirmation");

document.getElementById("reset-progression").onclick = function() {
    if (!profilActuel) return;
    modalConfirmation.classList.add("actif");
};

document.getElementById("btn-annuler-reset").onclick = function() {
    modalConfirmation.classList.remove("actif");
};

document.getElementById("btn-confirmer-reset").onclick = function() {
    const profils = getProfils();
    if (profils[profilActuel]) {
        profils[profilActuel].progression = {};
        saveProfils(profils);
    }
    modalConfirmation.classList.remove("actif");
    afficherProgression();
};

const modalSuppression = document.getElementById("modal-supprimer-profil");

document.getElementById("btn-annuler-suppression").onclick = () => {
    modalSuppression.classList.remove("actif");
    profilEnCoursSuppr = null;
};

document.getElementById("btn-confirmer-suppression").onclick = () => {
    if (profilEnCoursSuppr) {
        const profils = getProfils();
        delete profils[profilEnCoursSuppr];
        saveProfils(profils);
        afficherProfils();
        modalSuppression.classList.remove("actif");
        profilEnCoursSuppr = null;
    }
};

const modalTutoriel = document.getElementById("modal-tutoriel");

document.getElementById("btn-compris-tutoriel").onclick = () => {
    marquerTutorielVu();
    modalTutoriel.classList.remove("actif");
    if (leconActuelle) {
        window.open(leconActuelle.ex1, "_blank");
    }
};

afficherProfils();
afficher("accueil");
});
</script>
<!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('Service Worker enregistr√©', reg))
                .catch(err => console.log('Erreur Service Worker', err));
        }
    </script>
</body>
</html>